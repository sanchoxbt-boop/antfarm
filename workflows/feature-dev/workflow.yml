id: feature-dev
name: Feature Development Workflow
version: 3
description: |
  Executes a well-specified plan from the main agent.
  Main agent handles planning interactively with the human.
  This workflow handles execution: implement, verify, test, PR, review.

agents:
  - id: developer
    name: Developer
    description: Implements features, writes tests, creates PRs.
    workspace:
      baseDir: agents/developer
      files:
        AGENTS.md: agents/developer/AGENTS.md
        SOUL.md: agents/developer/SOUL.md
        TOOLS.md: shared/TOOLS.md
        IDENTITY.md: agents/developer/IDENTITY.md
        USER.md: shared/USER.md

  - id: verifier
    name: Verifier
    description: Quick sanity check - did developer actually do the work?
    workspace:
      baseDir: agents/verifier
      files:
        AGENTS.md: agents/verifier/AGENTS.md
        SOUL.md: agents/verifier/SOUL.md
        TOOLS.md: shared/TOOLS.md
        IDENTITY.md: agents/verifier/IDENTITY.md
        USER.md: shared/USER.md

  - id: tester
    name: Tester
    description: Thorough testing - runs tests, finds edge cases, browser testing if needed.
    workspace:
      baseDir: agents/tester
      files:
        AGENTS.md: agents/tester/AGENTS.md
        SOUL.md: agents/tester/SOUL.md
        TOOLS.md: shared/TOOLS.md
        IDENTITY.md: agents/tester/IDENTITY.md
        USER.md: shared/USER.md

  - id: reviewer
    name: Reviewer
    description: Reviews PRs, requests changes or approves.
    workspace:
      baseDir: agents/reviewer
      files:
        AGENTS.md: agents/reviewer/AGENTS.md
        SOUL.md: agents/reviewer/SOUL.md
        TOOLS.md: shared/TOOLS.md
        IDENTITY.md: agents/reviewer/IDENTITY.md
        USER.md: shared/USER.md

steps:
  - id: implement
    agent: developer
    input: |
      Implement the following plan. The main agent has already discussed this with the human.
      
      TASK:
      {{task}}
      
      Requirements:
      1. Find the relevant codebase
      2. Create a feature branch
      3. Implement each subtask
      4. Write tests for your changes
      5. Commit with clear messages
      
      Before completing, update your AGENTS.md and memory if you learned anything useful for future tasks.
      
      Reply with:
      STATUS: done
      
      REPO: /path/to/repo
      BRANCH: branch-name
      COMMITS: list of commit hashes
      CHANGES: what you implemented
      TESTS: what tests you wrote
    expects: "STATUS: done"
    max_retries: 2
    on_fail:
      escalate_to: human

  - id: verify
    agent: verifier
    input: |
      Quick verification: Did the developer actually complete the work?
      
      TASK:
      {{task}}
      
      REPO: {{repo}}
      BRANCH: {{branch}}
      CHANGES: {{changes}}
      
      Check:
      1. Code exists (not just TODOs or placeholders)
      2. Each part of the task was addressed
      3. No obvious incomplete work
      
      This is a quick sanity check, not deep testing.
      
      Before completing, update your AGENTS.md and memory if you learned anything useful.
      
      Reply with:
      STATUS: done
      VERIFIED: What you confirmed
      
      Or if incomplete:
      STATUS: retry
      ISSUES:
      - What's missing or incomplete
    expects: "STATUS: done"
    on_fail:
      retry_step: implement
      max_retries: 2
      on_exhausted:
        escalate_to: human

  - id: test
    agent: tester
    input: |
      Thorough testing of the implementation.
      
      TASK:
      {{task}}
      
      REPO: {{repo}}
      BRANCH: {{branch}}
      CHANGES: {{changes}}
      TESTS: {{tests}}
      
      Your job:
      1. Run the existing test suite
      2. Run the new tests
      3. Look for edge cases
      4. If this is a UI feature, use agent-browser to test it
      5. Check error handling
      
      Decide what testing approach makes sense for this task.
      
      Before completing, update your AGENTS.md and memory if you learned anything useful.
      
      Reply with:
      STATUS: done
      RESULTS: What you tested and the outcomes
      
      Or if issues found:
      STATUS: retry
      FAILURES:
      - Specific test failures or bugs found
    expects: "STATUS: done"
    on_fail:
      retry_step: implement
      max_retries: 2
      on_exhausted:
        escalate_to: human

  - id: pr
    agent: developer
    input: |
      Create a pull request for your changes.
      
      TASK:
      {{task}}
      
      REPO: {{repo}}
      BRANCH: {{branch}}
      CHANGES: {{changes}}
      RESULTS: {{results}}
      
      Create a PR with:
      - Clear title summarizing the change
      - Description explaining what and why
      - Reference to what was tested
      
      Use: gh pr create
      
      Reply with:
      STATUS: done
      PR: URL to the pull request
    expects: "STATUS: done"
    on_fail:
      escalate_to: human

  - id: review
    agent: reviewer
    input: |
      Review the pull request.
      
      PR: {{pr}}
      TASK: {{task}}
      CHANGES: {{changes}}
      
      Review for:
      - Code quality and clarity
      - Potential bugs or issues
      - Test coverage
      - Follows project conventions
      
      Use: gh pr view, gh pr diff
      
      If changes needed, add comments to the PR explaining what needs to change.
      
      Before completing, update your AGENTS.md and memory if you learned anything useful.
      
      Reply with:
      STATUS: done
      DECISION: approved
      
      Or if changes needed:
      STATUS: retry
      DECISION: changes_requested
      FEEDBACK:
      - What needs to change
    expects: "STATUS: done"
    on_fail:
      retry_step: implement
      max_retries: 3
      on_exhausted:
        escalate_to: human
